// Ù…Ù†ØµØ© Ø§Ù„Ø¯Ø±Ø§Ø³Ø© - Node.js + Express + SQLite
// app.js

const express = require('express');
const session = require('express-session');
const bcrypt = require('bcrypt');
const sqlite3 = require('sqlite3').verbose();
const path = require('path');

const app = express();
const PORT = 5000;

// Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
const db = new sqlite3.Database('./study.db', (err) => {
    if (err) console.error(err);
    else console.log('âœ… Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø§Ù‡Ø²Ø©');
});

// Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
db.serialize(() => {
    db.run(`CREATE TABLE IF NOT EXISTS users (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        first_name TEXT,
        last_name TEXT,
        email TEXT UNIQUE,
        password TEXT
    )`);
    
    db.run(`CREATE TABLE IF NOT EXISTS plants (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER,
        emoji TEXT,
        name TEXT,
        growth REAL DEFAULT 0,
        created DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY(user_id) REFERENCES users(id)
    )`);
    
    db.run(`CREATE TABLE IF NOT EXISTS tasks (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER,
        text TEXT,
        done INTEGER DEFAULT 0,
        FOREIGN KEY(user_id) REFERENCES users(id)
    )`);
    
    db.run(`CREATE TABLE IF NOT EXISTS study (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER UNIQUE,
        tokens INTEGER DEFAULT 5,
        FOREIGN KEY(user_id) REFERENCES users(id)
    )`);
    
    db.run(`CREATE TABLE IF NOT EXISTS schedule (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER,
        day TEXT,
        subject TEXT,
        time TEXT,
        FOREIGN KEY(user_id) REFERENCES users(id)
    )`);
});

// Middleware
app.use(express.json());
app.use(express.urlencoded({ extended: true }));
app.use(session({
    secret: 'study-platform-secret-key-2024',
    resave: false,
    saveUninitialized: false,
    cookie: { maxAge: 24 * 60 * 60 * 1000 }
}));

// HTML Template
const HTML = `<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…Ù†ØµØ© Ø§Ù„Ø¯Ø±Ø§Ø³Ø©</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Arial;background:linear-gradient(135deg,#1a4d3f 0%,#0d2621 100%);min-height:100vh;position:relative}
.hex-bg{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:0}
.hex{position:absolute;width:80px;height:46px;background:rgba(41,37,36,0.3);transition:all 0.3s}
.hex:before,.hex:after{content:"";position:absolute;width:0;border-left:40px solid transparent;border-right:40px solid transparent}
.hex:before{bottom:100%;border-bottom:23px solid rgba(41,37,36,0.3);transition:border-bottom-color 0.3s}
.hex:after{top:100%;border-top:23px solid rgba(41,37,36,0.3);transition:border-top-color 0.3s}
.hex:hover{background:rgba(34,197,94,0.6)}
.hex:hover:before{border-bottom-color:rgba(34,197,94,0.6)}
.hex:hover:after{border-top-color:rgba(34,197,94,0.6)}
.container{position:relative;z-index:1;max-width:500px;margin:50px auto;padding:20px}
.wide{max-width:1200px}
.card{background:rgba(255,255,255,0.95);border-radius:20px;padding:40px;box-shadow:0 20px 60px rgba(0,0,0,0.3);animation:slide 0.5s}
@keyframes slide{from{opacity:0;transform:translateY(-30px)}to{opacity:1;transform:translateY(0)}}
h1{text-align:center;color:#1a4d3f;margin-bottom:30px;font-size:28px}
h2{color:#1a4d3f;margin-bottom:15px;font-size:22px}
.form-group{margin-bottom:20px}
label{display:block;margin-bottom:8px;color:#333;font-weight:500}
input{width:100%;padding:12px 15px;border:2px solid #e0e0e0;border-radius:10px;font-size:14px;transition:all 0.3s}
input:focus{outline:none;border-color:#22c55e;box-shadow:0 0 0 3px rgba(34,197,94,0.1)}
.btn{width:100%;padding:14px;background:linear-gradient(135deg,#22c55e 0%,#16a34a 100%);color:white;border:none;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;transition:all 0.3s}
.btn:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(34,197,94,0.3)}
.toggle{text-align:center;margin-top:20px;color:#666}
.toggle a{color:#22c55e;text-decoration:none;font-weight:bold}
.name-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.error{background:#fee2e2;color:#991b1b;padding:12px;border-radius:8px;margin-bottom:15px;text-align:center}
.success{background:#dcfce7;color:#166534;padding:12px;border-radius:8px;margin-bottom:15px;text-align:center}
.dashboard{display:none}
.header{background:rgba(255,255,255,0.95);padding:20px;border-radius:15px;margin-bottom:20px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px}
.time{font-size:24px;font-weight:bold;color:#22c55e}
.grid{display:grid;gap:20px}
.box{background:rgba(255,255,255,0.95);padding:25px;border-radius:15px;box-shadow:0 5px 20px rgba(0,0,0,0.1)}
.plants{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:15px;margin-top:15px}
.plant{text-align:center;padding:15px;background:#f0fdf4;border-radius:10px;transition:all 0.3s;cursor:pointer}
.plant:hover{transform:scale(1.05);box-shadow:0 5px 15px rgba(34,197,94,0.2)}
.plant-icon{font-size:40px;margin-bottom:5px}
.plant-name{font-size:12px;color:#666}
.add-btn{background:#22c55e;color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:bold;transition:all 0.3s}
.add-btn:hover{background:#16a34a;transform:translateY(-2px)}
.add-btn:disabled{background:#ccc;cursor:not-allowed;transform:none}
.tokens{background:linear-gradient(135deg,#fbbf24 0%,#f59e0b 100%);color:white;padding:15px;border-radius:10px;text-align:center;font-size:20px;font-weight:bold;margin-bottom:15px}
.logout{background:#ef4444;color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:bold}
.logout:hover{background:#dc2626}
.tasks{list-style:none}
.task{padding:12px;background:#f9fafb;border-radius:8px;margin-bottom:10px;display:flex;align-items:center;gap:10px}
.task:hover{background:#f3f4f6}
.task input[type="checkbox"]{width:auto;cursor:pointer}
.task-input{display:flex;gap:10px;margin-top:15px}
.task-input input{flex:1}
.task-input button{padding:10px 20px;background:#22c55e;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:bold}
.del-btn{background:#ef4444;color:white;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;font-size:12px}
.table{width:100%;border-collapse:collapse;margin-top:15px}
.table th,.table td{padding:10px;border:1px solid #e0e0e0;text-align:center}
.table th{background:#f0fdf4;color:#1a4d3f;font-weight:bold}
.table input{padding:8px;border:1px solid #e0e0e0;border-radius:5px;text-align:center;width:100%}
.save-btn{width:100%;margin-top:15px;padding:12px;background:#22c55e;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:bold}
.empty{text-align:center;padding:40px 20px;color:#9ca3af}
.empty-icon{font-size:48px;margin-bottom:10px}
</style>
</head>
<body>
<div class="hex-bg" id="hexBg"></div>
<div class="container {{WIDE}}">
{{CONTENT}}
</div>
<script>
function makeHex(){
const bg=document.getElementById('hexBg');
bg.innerHTML='';
const rows=Math.ceil(window.innerHeight/60);
const cols=Math.ceil(window.innerWidth/90);
for(let r=0;r<rows;r++){
for(let c=0;c<cols;c++){
const h=document.createElement('div');
h.className='hex';
h.style.left=(c*90+(r%2)*45)+'px';
h.style.top=(r*69)+'px';
bg.appendChild(h);
}}}
async function loadPlants(){
try{
const r=await fetch('/api/plants');
const p=await r.json();
const g=document.getElementById('plants');
if(p.length===0){
g.innerHTML='<div class="empty"><div class="empty-icon">ğŸŒ±</div><p>Ø£Ø¶Ù Ù†Ø¨Ø§Øª!</p></div>';
return;
}
g.innerHTML='';
p.forEach(pl=>{
const d=document.createElement('div');
d.className='plant';
d.innerHTML='<div class="plant-icon" style="opacity:'+Math.min(pl.growth/100,1)+'">'+pl.emoji+'</div><div class="plant-name">'+pl.name+'</div><div class="plant-name">'+Math.floor(pl.growth)+'%</div>';
g.appendChild(d);
});
}catch(e){console.error(e)}}
async function addPlant(){
try{
const r=await fetch('/api/plants',{method:'POST'});
const res=await r.json();
if(res.success){
document.getElementById('tokens').textContent=res.tokens;
document.getElementById('addBtn').disabled=res.tokens===0;
await loadPlants();
}else{alert(res.message)}
}catch(e){console.error(e)}}
async function loadTasks(){
try{
const r=await fetch('/api/tasks');
const t=await r.json();
const l=document.getElementById('tasks');
if(t.length===0){
l.innerHTML='<div class="empty"><div class="empty-icon">âœ…</div><p>Ø£Ø¶Ù Ù…Ù‡Ù…Ø©!</p></div>';
return;
}
l.innerHTML='';
t.forEach(tk=>{
const li=document.createElement('li');
li.className='task';
li.innerHTML='<input type="checkbox" '+(tk.done?'checked':'')+' onchange="toggleTask('+tk.id+')"><span style="flex:1;text-decoration:'+(tk.done?'line-through':'none')+'">'+tk.text+'</span><button onclick="delTask('+tk.id+')" class="del-btn">Ø­Ø°Ù</button>';
l.appendChild(li);
});
}catch(e){console.error(e)}}
async function addTask(){
const inp=document.getElementById('newTask');
const txt=inp.value.trim();
if(!txt){alert('Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ù‡Ù…Ø©');return}
try{
await fetch('/api/tasks',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:txt})});
inp.value='';
await loadTasks();
}catch(e){console.error(e)}}
async function toggleTask(id){
try{
await fetch('/api/tasks/'+id+'/toggle',{method:'POST'});
await loadTasks();
}catch(e){console.error(e)}}
async function delTask(id){
if(!confirm('Ø­Ø°ÙØŸ'))return;
try{
await fetch('/api/tasks/'+id,{method:'DELETE'});
await loadTasks();
}catch(e){console.error(e)}}
async function saveSch(){
const inp=document.querySelectorAll('#schedule input');
const sch={};
inp.forEach(i=>{
const d=i.dataset.day;
if(!sch[d])sch[d]={};
if(i.type==='text')sch[d].subject=i.value;
else if(i.type==='time')sch[d].time=i.value;
});
try{
await fetch('/api/schedule',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(sch)});
alert('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸');
}catch(e){console.error(e)}}
async function loadSch(){
try{
const r=await fetch('/api/schedule');
const sch=await r.json();
const inp=document.querySelectorAll('#schedule input');
inp.forEach(i=>{
const d=i.dataset.day;
if(sch[d]){
if(i.type==='text')i.value=sch[d].subject||'';
else if(i.type==='time')i.value=sch[d].time||'';
}});
}catch(e){console.error(e)}}
window.addEventListener('load',()=>{
makeHex();
const logged={{LOGGED}};
if(logged){
loadPlants();
loadTasks();
loadSch();
const tok=parseInt(document.getElementById('tokens').textContent);
document.getElementById('addBtn').disabled=tok===0;
}});
window.addEventListener('resize',makeHex);
document.addEventListener('DOMContentLoaded',()=>{
const inp=document.getElementById('newTask');
if(inp)inp.addEventListener('keypress',e=>{if(e.key==='Enter')addTask()});
});
</script>
</body>
</html>`;

const AUTH_SIGNUP = `
<div class="card">
<h1>ğŸŒ± Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</h1>
{{ERROR}}
<form method="POST" action="/signup">
<div class="name-grid">
<div class="form-group"><label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„</label><input type="text" name="first_name" required></div>
<div class="form-group"><label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ø§Ù†ÙŠ</label><input type="text" name="last_name" required></div>
</div>
<div class="form-group"><label>Ø§Ù„Ø¨Ø±ÙŠØ¯</label><input type="email" name="email" required></div>
<div class="form-group"><label>ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label><input type="password" name="password" required></div>
<button type="submit" class="btn">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
</form>
<div class="toggle">Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ <a href="/?mode=login">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a></div>
</div>`;

const AUTH_LOGIN = `
<div class="card">
<h1>ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h1>
{{ERROR}}{{SUCCESS}}
<form method="POST" action="/login">
<div class="form-group"><label>Ø§Ù„Ø¨Ø±ÙŠØ¯</label><input type="email" name="email" required></div>
<div class="form-group"><label>ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label><input type="password" name="password" required></div>
<button type="submit" class="btn">Ø¯Ø®ÙˆÙ„</button>
</form>
<div class="toggle">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ <a href="/?mode=signup">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</a></div>
</div>`;

const DASHBOARD = `
<div class="dashboard" style="display:block">
<div class="header">
<h2 style="margin:0">Ù…Ø±Ø­Ø¨Ø§Ù‹ {{NAME}} ğŸ‘‹</h2>
<div class="time">â±ï¸ 5:00:00</div>
<form method="POST" action="/logout" style="margin:0"><button class="logout">Ø®Ø±ÙˆØ¬</button></form>
</div>
<div class="grid">
<div class="box">
<h2>ğŸŒ¿ Ø­Ø¯ÙŠÙ‚Ø© Ø§Ù„Ù†Ø¨Ø§ØªØ§Øª</h2>
<div class="tokens">ğŸ’° Ø§Ù„Ø±Ù…ÙˆØ²: <span id="tokens">{{TOKENS}}</span></div>
<button class="add-btn" onclick="addPlant()" id="addBtn">â• Ù†Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯</button>
<div class="plants" id="plants"><div class="empty"><div class="empty-icon">ğŸŒ±</div><p>Ø£Ø¶Ù Ù†Ø¨Ø§Øª!</p></div></div>
</div>
<div class="box">
<h2>ğŸ“ Ø§Ù„Ù…Ù‡Ø§Ù…</h2>
<ul class="tasks" id="tasks"><div class="empty"><div class="empty-icon">âœ…</div><p>Ø£Ø¶Ù Ù…Ù‡Ù…Ø©!</p></div></ul>
<div class="task-input">
<input type="text" id="newTask" placeholder="Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©">
<button onclick="addTask()">Ø¥Ø¶Ø§ÙØ©</button>
</div>
</div>
<div class="box">
<h2>ğŸ“… Ø§Ù„Ø¬Ø¯ÙˆÙ„</h2>
<table class="table">
<thead><tr><th>Ø§Ù„ÙŠÙˆÙ…</th><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„ÙˆÙ‚Øª</th></tr></thead>
<tbody id="schedule">
<tr><td>Ø§Ù„Ø³Ø¨Øª</td><td><input type="text" data-day="sat"></td><td><input type="time" data-day="sat"></td></tr>
<tr><td>Ø§Ù„Ø£Ø­Ø¯</td><td><input type="text" data-day="sun"></td><td><input type="time" data-day="sun"></td></tr>
<tr><td>Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†</td><td><input type="text" data-day="mon"></td><td><input type="time" data-day="mon"></td></tr>
<tr><td>Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</td><td><input type="text" data-day="tue"></td><td><input type="time" data-day="tue"></td></tr>
<tr><td>Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</td><td><input type="text" data-day="wed"></td><td><input type="time" data-day="wed"></td></tr>
<tr><td>Ø§Ù„Ø®Ù…ÙŠØ³</td><td><input type="text" data-day="thu"></td><td><input type="time" data-day="thu"></td></tr>
<tr><td>Ø§Ù„Ø¬Ù…Ø¹Ø©</td><td><input type="text" data-day="fri"></td><td><input type="time" data-day="fri"></td></tr>
</tbody>
</table>
<button class="save-btn" onclick="saveSch()">ğŸ’¾ Ø­ÙØ¸</button>
</div>
</div>
</div>`;

// Routes
app.get('/', (req, res) => {
    const mode = req.query.mode || 'signup';
    
    if (req.session.userId) {
        db.get('SELECT * FROM users WHERE id = ?', [req.session.userId], (err, user) => {
            if (err || !user) return res.redirect('/logout');
            
            db.get('SELECT * FROM study WHERE user_id = ?', [user.id], (err, study) => {
                if (!study) {
                    db.run('INSERT INTO study (user_id) VALUES (?)', [user.id], function() {
                        study = { tokens: 5 };
                        sendDashboard(res, user, study);
                    });
                } else {
                    sendDashboard(res, user, study);
                }
            });
        });
    } else {
        const content = mode === 'login' ? AUTH_LOGIN : AUTH_SIGNUP;
        const html = HTML.replace('{{CONTENT}}', content)
            .replace('{{ERROR}}', '')
            .replace('{{SUCCESS}}', '')
            .replace('{{WIDE}}', '')
            .replace('{{LOGGED}}', 'false');
        res.send(html);
    }
});

function sendDashboard(res, user, study) {
    const content = DASHBOARD
        .replace('{{NAME}}', user.first_name + ' ' + user.last_name)
        .replace('{{TOKENS}}', study.tokens);
    const html = HTML.replace('{{CONTENT}}', content)
        .replace('{{WIDE}}', 'wide')
        .replace('{{LOGGED}}', 'true');
    res.send(html);
}

app.post('/signup', async (req, res) => {
    const { first_name, last_name, email, password } = req.body;
    
    db.get('SELECT * FROM users WHERE email = ?', [email], async (err, user) => {
        if (user) {
            const content = AUTH_SIGNUP.replace('{{ERROR}}', '<div class="error">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ø³ØªØ®Ø¯Ù…</div>');
            const html = HTML.replace('{{CONTENT}}', content).replace('{{WIDE}}', '').replace('{{LOGGED}}', 'false');
            return res.send(html);
        }
        
        const hash = await bcrypt.hash(password, 10);
        const code = Math.floor(100000 + Math.random() * 900000);
        
        db.run('INSERT INTO users (first_name, last_name, email, password) VALUES (?, ?, ?, ?)',
            [first_name, last_name, email, hash], function() {
                db.run('INSERT INTO study (user_id) VALUES (?)', [this.lastID]);
                console.log(`\nâœ… Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯: ${email} - ÙƒÙˆØ¯: ${code}\n`);
                
                const content = AUTH_LOGIN
                    .replace('{{ERROR}}', '')
                    .replace('{{SUCCESS}}', `<div class="success">ØªÙ…! ÙƒÙˆØ¯: ${code}</div>`);
                const html = HTML.replace('{{CONTENT}}', content).replace('{{WIDE}}', '').replace('{{LOGGED}}', 'false');
                res.send(html);
            });
    });
});

app.post('/login', async (req, res) => {
    const { email, password } = req.body;
    
    db.get('SELECT * FROM users WHERE email = ?', [email], async (err, user) => {
        if (!user || !(await bcrypt.compare(password, user.password))) {
            const content = AUTH_LOGIN
                .replace('{{ERROR}}', '<div class="error">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>')
                .replace('{{SUCCESS}}', '');
            const html = HTML.replace('{{CONTENT}}', content).replace('{{WIDE}}', '').replace('{{LOGGED}}', 'false');
            return res.send(html);
        }
        
        req.session.userId = user.id;
        res.redirect('/');
    });
});

app.post('/logout', (req, res) => {
    req.session.destroy();
    res.redirect('/');
});

// API Routes
app.get('/api/plants', (req, res) => {
    if (!req.session.userId) return res.json([]);
    
    db.all('SELECT * FROM plants WHERE user_id = ?', [req.session.userId], (err, plants) => {
        plants = plants.map(p => {
            const elapsed = (Date.now() - new Date(p.created).getTime()) / 1000;
            const growth = Math.min(100, p.growth + (elapsed / 60) * 2);
            db.run('UPDATE plants SET growth = ? WHERE id = ?', [growth, p.id]);
            return { ...p, growth: Math.round(growth * 10) / 10 };
        });
        res.json(plants);
    });
});

app.post('/api/plants', (req, res) => {
    if (!req.session.userId) return res.json({ success: false });
    
    db.get('SELECT * FROM study WHERE user_id = ?', [req.session.userId], (err, study) => {
        if (study.tokens <= 0) return res.json({ success: false, message: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ù…ÙˆØ²' });
        
        const emojis = ['ğŸŒ±','ğŸŒ¿','ğŸŒ¾','ğŸŒ³','ğŸŒ²','ğŸŒ´','ğŸŒµ','ğŸŒ·','ğŸŒ¹','ğŸŒº','ğŸŒ»','ğŸŒ¼','ğŸª´','ğŸ€'];
        const emoji = emojis[Math.floor(Math.random() * emojis.length)];
        
        db.get('SELECT COUNT(*) as count FROM plants WHERE user_id = ?', [req.session.userId], (err, result) => {
            const name = `Ù†Ø¨Ø§Øª ${result.count + 1}`;
            
            db.run('INSERT INTO plants (user_id, emoji, name) VALUES (?, ?, ?)',
                [req.session.userId, emoji, name], function() {
                    db.run('UPDATE study SET tokens = tokens - 1 WHERE user_id = ?', [req.session.userId]);
                    res.json({ success: true, tokens: study.tokens - 1 });
                });
        });
    });
});

app.get('/api/tasks', (req, res) => {
    if (!req.session.userId) return res.json([]);
    db.all('SELECT * FROM tasks WHERE user_id = ?', [req.session.userId], (err, tasks) => {
        res.json(tasks.map(t => ({ ...t, done: Boolean(t.done) })));
    });
});

app.post('/api/tasks', (req, res) => {
    if (!req.session.userId) return res.json({ success: false });
    db.run('INSERT INTO tasks (user_id, text) VALUES (?, ?)', [req.session.userId, req.body.text], () => {
        res.json({ success: true });
    });
});

app.post('/api/tasks/:id/toggle', (req, res) => {
    db.run('UPDATE tasks SET done = NOT done WHERE id = ? AND user_id = ?',
        [req.params.id, req.session.userId], () => {
            res.json({ success: true });
        });
});

app.delete('/api/tasks/:id', (req, res) => {
    db.run('DELETE FROM tasks WHERE id = ? AND user_id = ?', [req.params.id, req.session.userId], () => {
        res.json({ success: true });
    });
});

app.get('/api/schedule', (req, res) => {
    if (!req.session.userId) return res.json({});
    db.all('SELECT * FROM schedule WHERE user_id = ?', [req.session.userId], (err, schedules) => {
        const result = {};
        schedules.forEach(s => {
            result[s.day] = { subject: s.subject || '', time: s.time || '' };
        });
        res.json(result);
    });
});

app.post('/api/schedule', (req, res) => {
    if (!req.session.userId) return res.json({ success: false });
    
    db.run('DELETE FROM schedule WHERE user_id = ?', [req.session.userId], () => {
        const data = req.body;
        for (const [day, info] of Object.entries(data)) {
            if (info.subject || info.time) {
                db.run('INSERT INTO schedule (user_id, day, subject, time) VALUES (?, ?, ?, ?)',
                    [req.session.userId, day, info.subject || '', info.time || '']);
            }
        }
        res.json({ success: true });
    });
});

// Start Server
app.listen(PORT, () => {
    console.log('\n' + '='.repeat(60));
    console.log('ğŸŒ± Ù…Ù†ØµØ© Ø§Ù„Ø¯Ø±Ø§Ø³Ø© - Node.js');
    console.log('='.repeat(60));
    console.log('\n1. ØªØ«Ø¨ÙŠØª: npm install express express-session bcrypt sqlite3');
    console.log('2. ØªØ´ØºÙŠÙ„: node app.js');
    console.log(`3. ÙØªØ­: http://localhost:${PORT}`);
    console.log('\n' + '='.repeat(60) + '\n');
});
